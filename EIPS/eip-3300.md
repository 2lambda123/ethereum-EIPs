---
eip: 3300
title: Phase out refunds
author: William Morriss (@wjmelements)
discussions-to: https://ethereum-magicians.org/t/eip-3300-phase-out-refunds/5434
status: Draft
type: Standards Track
category: Core
created: 2020-02-26
---

## Simple Summary
Phases out the `SSTORE` and `SELFDESTRUCT` gas refunds.

## Abstract
This EIP would define a block when the `SSTORE` and `SELFDESTRUCT` refunds would begin to diminish.
The refund would step linearly downward, eroding the implicit value of such refunds at an accelerating pace.

## Motivation
Refunds increase block elasticity, so the block gas target can exceed the number established by miners by up to 2x.
This can cause hesitancy for miners to increase the block gas target.

Refunds, tokenized or not, are valuable to their holders, especially during congestion.
If refunds must be removed, a gradual change in their value would be less-disruptive to the gas market than sudden abolition.
Refund consumption would proceed, especially during periods of congestion, and the refunds would be cleaned up from the state.
Refund creation, driven by demand, would naturally diminish as the efficiency of the refunds fall.
As the refund value approaches the activation cost, the tokens will approach zero, but in periods of congestion they will be cleaned up.

This change is less work for the protocol developers than compensation and cleanup, while likely still achieving cleanup.


## Specification
On the block this EIP activates, and again every 100 blocks, all gas refunds, including `SELFDESTRUCT` and `SSTORE` would diminish by 1, until 0.
The current difference is called the `REFUND_DECAY`, which shall be subtracted universally from all specified refunds.
For gas-cost regimes with refund removals that cancel prior refunds, the invariant that the refund counter cannot go negative will be preserved by diminishing the magnitude of those removals by `REFUND_DECAY`, until 0.


### Example: EIP-1283 SSTORE pricing
Under EIP-1283 there are three distinct `SSTORE` refunds, and each would be diminished according to block height.
See the EIP-1283 definitions for original value, current value, and new value.

* Where the new value is zero, but the original and current value were non-zero but different, the activation cost is 5000 and the refund is 15000.
* Where the new value is zero, but the original value was equal to the current value, and the current value is non-zero, the activation cost is 200 gas, and the refund is 15000.
* Where the new value is zero, but the original value was zero and the current value is non-zero, the activation cost is 200 gas, and the refund is 19800.
* Where the new value is non-zero and equals the original value but not the current value, the activation cost is 200, and the refund is 4800.

In this case the refunds of different sizes are distinct.
The activation cost for the 19800 refund is 200.
The activation cost for the 15000 refund is 200.
The activation cost for the 4800 refund is 200.
The last to expire would be the 19800 refund for reseting storage in the same transaction.

EIP-1283 also has a case with negative refunds, which should similarly diminish in order to maintain its invariant that the refund counter cannot go negative.

* Where the new value is non-zero, but the original value was non-zero and the current value is zero, `SSTORE` costs 200 and removes 15000 from the refund counter.

This refund removal would diminish on the same schedule as the 15000 refunds above, becoming zero when any refund that could be negated becomes zero.
The removal causing the removal of the negative refund in this case would be the first 15,000 refund with its 5000 activation cost.
This preserves the invariant that the refund counter cannot go negative.


### Example: EIP-2929 SSTORE and SELFDESTRUCT pricing
EIP-2929 adds warm and cold storage concepts to the pricing model.
The specification can be augmented with another parameter, `REFUND_DECAY`, that shall be subtracted from all specified refunds.

#### SSTORE
The cases are similar to EIP-1283 but one case is now subdivided into warm and cold.

* Where the new value is zero, but the original and current value were non-zero but different, this is a warm read with activation cost 100 that refunds 15000.
* Where the new value is zero, but the original value was equal to the current value, and the current value is non-zero, the activation cost of the 15000 refund is 2900 if cold else 5000.
* Where the new value is zero, but the original value was zero and the current value is non-zero, this is a warm read with activation cost 2900 and refund 19900.
* Where the new value is non-zero and equals the original value but not the current value, this is a warm read with activation cost 100 and refund 4900.

The activation cost for the 19900 refund is 2900.
The activation cost for the 15000 refund is 100.
The activation cost for the 4900 refund is 100.

There is also a case where `SSTORE` removes from the refund counter.

* Where the new value is non-zero, but the original value was non-zero and the current value is zero, this is a warm read, `SSTORE` costs 100, and removes 15000 from the refund counter.

To preserve the refund


#### SELFDESTRUCT
The gas cost of `SELFDESTRUCT` is either 5000 or 7600 according to whether the recipient was previously accessed.
So the refund activation cost is 5000.


## Rationale
Persisted refunds would become worthless before they fall below their activation cost, so they can be safely removed at that point.
Once the refunds are worthless, they can be removed by another hard fork without waiting for 0.
The rate of diminishing specified would currently require (24000-5000) * 100 = 1,900,000 blocks for `SELFDESTRUCT` and (15000-5000) * 100 = 1,000,000 blocks for `SSTORE`.
This timeframe is currently about a year, which should be enough flexibility for the remaining refunds to be consumed.


## Backwards Compatibility
This proposal breaks gas refunds, which contribute to block elasticity.
The effect of this will be increased gas price volatility: higher highs and lower lows.

Because the refund counter is separate from the gas counter, the block-to-block gas changes will not break `eth_estimateGas`.

## Copyright
Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
