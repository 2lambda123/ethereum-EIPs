---
eip: 1102
title: Opt-in web3 access
author: Paul Bouchon <mail@bitpshr.net>
discussions-to: https://ethereum-magicians.org/t/opt-in-web3-access/414
status: Draft
type: Standards Track
category: Interface
created: 2018-05-04
---

## Simple summary

This proposal describes a new way for DOM environments to expose the web3 provider that requires user approval.

## Abstract

MetaMask and most other tools that provide access to web3-enabled environments do so automatically and without user consent. This exposes users of such environments to fingerprinting attacks since untrusted websites can check for a `web3` object and reliably identify web3-enabled clients.

This proposal outlines a new protocol in which dapps request access to a web3 provider instead of relying on its preexistence in a given DOM environment.

## Specification

### Typical dapp initialization

```
START dapp
IF web3 is defined
    CONTINUE dapp
IF web3 is undefined
    STOP dapp
```

### Proposed dapp initialization

```
START dapp
REQUEST[1] web3 provider
    IF user approves
        NOTIFY[2] dapp
        CONTINUE dapp
    IF user rejects
    IF non-web3 environment
      NOOP[3]
```

#### `[1] REQUEST`

Dapps MUST request the web3 provider by sending a message using [`window.postMessage`](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) API. This message MUST be sent with a payload object containing a `type` property with a value of `REQUEST_ETHEREUM_PROVIDER`.

#### `[2] NOTIFY`

Dapps browsers MUST notify dapps of successful web3 exposure by sending a message using [`window.postMessage`](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) API. This message MUST be sent with a payload object containing a `event.type` property with a value of `REQUEST_ETHEREUM_PROVIDER` and a `event.data.ethereum` property containing the ethereum provider as specified in [ethereum/interfaces#16](https://github.com/ethereum/interfaces/issues/16).

#### `[3] NOOP`

If a user rejects web3 access on an untrusted site, the site itself MUST NOT be notified in any way; notification of a rejection would allow third-party tools to still identify that a client is web3-enabled despite not being granted web3 access.

### Example implementation: `postMessage`

The following example demonstrates one possible implementation of this strategy in a browser-based DOM environment. Note that web3 environments on other platforms would most likely use platform-specific native messaging protocols, not `postMessage`.

```js
// listen for web3 provider
window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'REQUEST_ETHEREUM_PROVIDER') {
    // supplied provider, start dapp
    startDapp(event.data.ethereum);
  }
});
// request web3 provider
window.postMessage({ type: 'REQUEST_ETHEREUM_PROVIDER' });
```

## Rationale

An [open issue](https://github.com/MetaMask/metamask-extension/issues/714) against the [MetaMask](https://github.com/MetaMask/metamask-extension) extension has received community upvotes and Richard Burton of the [Balance](https://github.com/balance-io) team published a well-received [blog post](https://medium.com/@ricburton/metamask-walletconnect-js-b47857efb4f7) discussing these potential changes.

### Constraints

* Web3 MUST NOT be exposed to websites by default.
* Dapps MUST request web3 if it does not exist.
* Users MUST be able to approve or reject web3 access.
* Web3 MUST be exposed to websites after user consent.
* Environments MAY continue auto-exposing web3 if users can disable this behavior.

### Immediate value-add

* Users can reject web3 access on untrusted sites to prevent web3 fingerprinting.

### Long-term value-add

* Dapps could request specific account information based on user consent.
* Dapps could request specific user information based on user consent (uPort, DIDs).
* Dapps could request a specific network based on user consent.
* Dapps could request multiple instances of the above based on user consent.

## Backwards compatibility

This proposal impacts dapp authors and requires that they request access to a web3 provider before using it. This proposal also impacts developers of web3-enabled environments or dapp browsers as these tools should no longer auto-expose the web3 API; instead, they should only do so if a website requests the provider and if the user consents to its access. Environments may continue to auto-expose the web3 API as long as users have the ability to disable this behavior, but it is not suggested.

## Implementation

The MetaMask team is currently working an [MVP implementation](https://github.com/MetaMask/metamask-extension/issues/3930) of the strategy described above and expects to begin limited user testing soon.

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
