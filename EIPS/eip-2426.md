---
eip: 2426
title: Encryption for Ethereum 2 walletstore and keystore
author: Jim McDonald <Jim@mcdee.net>
discussions-to: https://ethereum-magicians.org/t/encryption-for-ethereum-2-walletstore-and-keystore/3828
status: Draft
type: Standards Track
category: ERC
created: 2019-12-04
requires: 2335, 2386
---

## Simple Summary

An encryption and decryption method for Ethereum 2 walletstore and keystore files, along with a binary format for storing the encrypted data with the parameters required to decrypt them.

## Abstract

Ethereum [walletstore](https://eips.ethereum.org/EIPS/eip-2335) and [keystore](https://eips.ethereum.org/EIPS/eip-2386) files (hereafter just "stores") have various fields that some users may consider private (_e.g._ name, pubkey).  In addition, there is always the risk of stores being stolen or made publically accessible.  To counteract potential issues this defines an encrypted format for stores.

## Motivation

There is always a balance between accessibility and privacy of data: users commonly want their data to be fully accessible to themselves but private to every other part.  To give a simple example: a keystore contains a public key that allows users to view their transactions without unlocking the wallet, but they may not want others to do so if the user leaves their keystore accessible.

An encrypted store provides an additional layer of security: they must be unlocked before any information about them is visible (and unlocked with a second key before they can send transactions, sign messages, _etc._)

## Specification

### Encrypting the store

Encrypting the store requires the following information:

  - the store to encrypt, which MUST be at least 16 bytes in length
  - the passphrase, which MUST be at least 1 byte in length
  - a randomly-generated salt, which MUST be 32 bytes in length
  - a randomly-generated initialization vector, which MUST be 16 bytes in length

An _encryption key_ is generated using [PBKDF2](https://www.ietf.org/rfc/rfc2898.txt), with the following parameters:

  - key: the passphrase as supplied above
  - salt: the salt as generated above
  - number of iterations: MUST be 262144
  - keylen: MUST be 32
  - PRF: MUST be "hmac-sha256"

The _encrypted data_ is encrypted using [AES-128-CTR](https://tools.ietf.org/html/rfc3686), with the following parameters:

  - key: the first 16 bytes of the encryption key as calculated above
  - iv: the initialization vector as generated above
  - data: the store as supplied above

Finally, a _checksum_ is generated by appending the encrypted data to the last 16 bytes of the encryption key and calculating its [SHA-256](https://tools.ietf.org/html/rfc6234) hash.

### Decrypting the store

Decrypting the store is the opposite procedure to that laid out in the above section.  Decrypting the store requires the following information:

  - the encrypted store to decrypt
  - the passphrase, which MUST be at least 1 byte in length
  - the salt, which MUST be 32 bytes in length
  - the initialization vector, which MUST be 16 bytes in length
  - the checksum, which MUST be 32 bytes in length

A _decryption key_ is generated using [PBKDF2](https://www.ietf.org/rfc/rfc2898.txt), with the following parameters:

  - key: the passphrase as supplied above
  - salt: the salt as supplied above
  - number of iterations: MUST be 262144
  - keylen: MUST be 32
  - PRF: MUST be "hmac-sha256"

A _calculated checksum_ is generated by appending the encrypted store to the last 16 bytes of the decryption key and calculating its [SHA-256](https://tools.ietf.org/html/rfc6234) hash.  If the calculated checksum does not match the checksum the decryption process MUST halt and return a suitable error.

The _data_ is decrypted using [AES-128-CTR](https://tools.ietf.org/html/rfc3686), with the following parameters:

  - key: the first 16 bytes of the decryption key as calculated above
  - iv: the initialization vector as supplied above
  - data: the encrypted data as supplied above

Note this is the same process as laid out in [EIP-2335](https://eips.ethereum.org/EIPS/eip-2335) with the KDF set to `PBKDF2-SHA-256`.

### Encrypted store format

As can be seen above, in addition to the encrypted data a number of additional items must be stored to allow for successful decryption.  The encrypted store format provides a well-known binary structure which allows these items to be extracted and used when attempting decryption.

The encrypted store format is a pure binary format.  As such there are no expectations that the resultant file contains only ASCII characters and should be treated as such.

#### Version: 1 byte
This defines the version of encryption.  This MUST be set to 1

#### Salt: 32 bytes
This is the salt used for encryption as per the section 'Encrypting the store'.

#### Initialisation vector: 16 bytes
This is the initialization vector used for encryption as per the section 'Encrypting the store'.

#### Checksum: 16 bytes
This is the checksum generated for encrypted data as per the section 'Encrypting the store'.

#### Data: variable
This is the encrypted data itself.

## Test Cases

### Walletstore Test Vector

Passphrase `test passphrase`

#### Binary format

`01be05e244a820c87646908873dc9f7d7839685679f01816e8e14911d8413577edabd186afb3ba260c8936519edd82f7f6eac04ef5a279652eadae5fbc0b70129d4fd31c7de22c23b8328b7556fe82555ea0934a4745feeb99269782175dc00d87f5f346df5b53e3735146dbbdd3ac7e2c31d242d92952dde4596752915ce9c576c902e1b7b549d24188b93e166fd99e5fa2ff9a0a51f151558ec48db2f73f83d4f6db2d4ba4db7a83def1c4ece3b9271d1bd7d91628a61e0dea07184f66662ca10e7e77d27f90358a93b1968ca7eeb3c57718c1e93fec8f132cbba3093a91d37e6dbc632849cd89679f901182317607a8e0445c43ce6c5b4febbad6f755f8009e33ca865a6f60b0f7cc30c882d399b2d04f28ba4b69f41922005e94793df45559b7cab78f2210973f06632665ca269a9f09c0065b69d9d0744952b90a0bfe198cd5e94a160c3f147578d368098962d7e9c77d43a3a7cdbe2d9c0e25574620ad48da911a23e06115201b2f59af9b4033b5768da3c53a51969e5ec2b5fa6e34c7480831e8d0bf3f315761557500283fe83c9645c647fa15b6d11dd8ef614755ca393b2ad8ec793c1b98c838ec97ac824b55f068427820d5c2f74733524f40bfc4cbb9e12abcb7dc6848112f55284f8c0238238f47f8bc445560f62ab68ac04aab779d7d21e2dc0533db620e26982ecc21c6c9e0b15ef1c4c82eba17510c2628bcf4acf9fbdf555d43a5af15045451a5419f6b73e785c48bc609295be11f7b4a8b275121ac9138efad542d97719b5f38b18dc618e3bdea969946c2181671a0d688f85f3b46032fbfa5cfeefd45c5a3d5f383d97c759bd4ad835160d334a2503005cc0feb7d0b7414c439f14ecd42cce33c23499396f5f1f4923c47ce9e6ef507b6ebd419be6372288df20bed3dfc742c61e3aa1753b22719b63531dd758185171f`

#### JSON format

```json
{"crypto":{"checksum":{"function":"sha256","message":"6d02c54597b0d06fd3da675dfaa4eecd92ebe7e175241b5402b513e493f1749c","params":{}},"cipher":{"function":"aes-128-ctr","message":"193d0db8a3b93bbfb52f4dbf32a6d56cd8a9ecc4096f586e930561f8d81d6f4b","params":{"iv":"1f1360e7782865378272c0ce71b821fe"}},"kdf":{"function":"pbkdf2","message":"","params":{"c":16,"dklen":32,"prf":"hmac-sha256","salt":"7e3826374a953542aa0bb1dfc2222d7a9d342c72ff99683446f10dddeef6b982"}}},"name":"HD wallet","nextaccount":0,"type":"hierarchical deterministic","uuid":"7a721d01-7e3f-4eb2-90b6-1aa33ca2efe9","version":1}
```

### Keystore Test Vector

Passphrase `test passphrase`

#### Binary format

`012ab08d338ca48096fb3321641a3fddf637c1e9433e3570b7cf96b8e6c92a618b3621f0228b21ac7bb2633e9f3779e73ec38836fcbd6d905473f92eaeed5e5e4da57dee3531ad24a46ce3deeed9f8ce48bd99e0562da139a5bb44046a110e7a6bd04796436ecfec98645bd756af130b16d2c891c0adba4abb27f5fdb7b3e760ff26b3007f5de820d0990e781ab1d28c5cf7194addf7debab63a8bbd1e8d7d0a4e7fbb29241d571e85e36153044c5537ee79ea805856ea22fd103c9973706067707b985b45d7c6576b8eaad97d29854817bfb6c5a89794853d1eedb5cb1d359d604fdaf59745e6a6d90b837114a1da320ff4474c2b5a2420671872bc103c5dbfb50c255d40e7d52c3706e80623e925f8b071654bc57e6039e6c1affa2148879ce2c2c3eb0e7c7bb4c448d5b542f754ff2ebf54b3756cd08867415e630d2e3126018706d2d715289c9c19436cd247a95c42960b07aee31ef0380bdad1eca83d8832d2a64a47559bbb1a454a06771eb11c650b25961cf2d5c3a7226327bfb73f14bd49fd09e951b9a826be6cf67662f290af07f63e2988e1936ee600ea647e1ba589f33228b13bd7ab01584bb52c8822bd455a47e861cd214c73902c593980133213fb84f2710b1b79896d53d65c4d3e8594f94694785e2d16ea5a02102338b4b4a82672fc6f4f18c45e0469490a8f2f561d4a11e8676dc4973fbc7f62f908214ac50e992ad647f4b27e32f995e75f6c47165ad1aad34e138426cd2f5049f45ed041ccbae9a213c60537edd789780ba8bb409908e40e3a7dc86e8a207eb1bb59b0f51979689eeaea36a4962c7b1ae447b99e083e43adafda444676c17cdb43a8c6474201e30cac06ed141869ef8de31a1db123aea5c931565720e475f1b821bab5ae6ae792f204e26009baf3f2f1d89c8302a8fbe9e0bb6936fe6cf5a5ab3f43b70c9e22dc325363c4974f5b78d979f632817abbe731f47230de5ddd2f53cf9dabfc7c0a7bb4b5dfe145dab40605ee839bd040dcaf89d28814a31b7b87db2243d2f4c6ab60e1536bef602ae02e6e6b8b1eac35`

#### JSON format

```json
{"crypto":{"checksum":{"function":"sha256","message":"e89b55138ce8f036df62feb048c5471825cf8a042dca15d8e8a899b8f8ad3ca3","params":{}},"cipher":{"function":"aes-128-ctr","message":"a9f7c2a1fea064fd908ad0685dff3913510848d66a438b3ae59ccf456762e3d5","params":{"iv":"455ca537e6aac4b9e0033de2ae56bf4c"}},"kdf":{"function":"pbkdf2","message":"","params":{"c":16,"dklen":32,"prf":"hmac-sha256","salt":"4129be545c70381eba21edcd5aecf29aa2f7b84c181581290618d62f9b896a4c"}}},"name":"account 1","path":"m/12381/3600/0/0","pubkey":"a6f0e4f874a26b2d938e887a94f7e5e5e824bf498edcc3fced8404c346f70e56aba575a977d71686f7e3680e5173c7bc","uuid":"2d5256ed-ba25-4a3e-b887-c3d4c6830b41","version":4}
```

## Implementation

A Go implementation for encoding and decoding data with the above standard can be found at [https://github.com/wealdtech/go-ecodec](https://github.com/wealdtech/go-ecodec).

A Go implementation of a wallet that implements store encryption can be found at [https://github.com/wealdtech/ethdo](https://github.com/wealdtech/ethdo).

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
